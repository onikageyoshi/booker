<!DOCTYPE html>
<html>
<head>
    <title>Test Stripe Payment</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: Arial; padding: 30px; }
        #card-element { padding: 12px; border: 1px solid #ccc; margin-bottom: 20px; }
        button { padding: 12px 20px; font-size: 16px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>

<h2>Pay for Booking</h2>

<p><strong>Apartment:</strong> {{ booking.apartment.title }}</p>
<p><strong>Total:</strong> {{ booking.total_price }} {{ booking.apartment.pricing.currency }}</p>

<div id="card-element"></div>

<button id="pay-btn">Pay Now</button>

<p id="message"></p>

<script>
const stripe = Stripe("{{ stripe_public_key }}");
const elements = stripe.elements();
const card = elements.create("card");
card.mount("#card-element");

const payBtn = document.getElementById("pay-btn");
const message = document.getElementById("message");

payBtn.addEventListener("click", async () => {
    payBtn.disabled = true;
    message.textContent = "Processing payment...";

    // 1Ô∏è‚É£ Create PaymentIntent
    const response = await fetch("/payments/stripe/create-intent/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({
            booking_id: "{{ booking.id }}"
        })
    });

    const data = await response.json();

    if (!response.ok) {
        message.textContent = data.detail || "Payment error";
        message.className = "error";
        payBtn.disabled = false;
        return;
    }

    // 2Ô∏è‚É£ Confirm card payment
    const result = await stripe.confirmCardPayment(
        data.client_secret,
        {
            payment_method: {
                card: card,
            }
        }
    );

    if (result.error) {
        message.textContent = result.error.message;
        message.className = "error";
        payBtn.disabled = false;
    } else {
        message.textContent = "Payment successful üéâ";
        message.className = "success";
    }
});
</script>

</body>
</html>
